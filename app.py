import streamlit as st
import pandas as pd
import numpy as np

# ---------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • (ì›¹ì‚¬ì´íŠ¸ ì œëª© ë“±)
# ---------------------------------------------------------
st.set_page_config(page_title="ì¬ê³  ìµœì í™” ì‹œë®¬ë ˆì´í„°", layout="wide")

st.title("ğŸ­ ìƒì‚° ê³„íš & ì¬ê³  ìµœì í™” ëŒ€ì‹œë³´ë“œ")
st.markdown("""
ì´ ëŒ€ì‹œë³´ë“œëŠ” **ìˆ˜ìš” ë³€ë™ì„±(Risk)**ê³¼ **ë¦¬ë“œíƒ€ì„(Lead Time)**ì„ ê³ ë ¤í•˜ì—¬ 
ìµœì ì˜ **ì•ˆì „ ì¬ê³ (Safety Stock)**ë¥¼ ì‚°ì¶œí•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
""")

# ---------------------------------------------------------
# 2. ì‚¬ì´ë“œë°”: ì‚¬ìš©ì ì…ë ¥ (User Input)
# ---------------------------------------------------------
st.sidebar.header("ğŸ”§ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •")

# ë¦¬ë“œíƒ€ì„: ì›ìì¬ ë°œì£¼ë¶€í„° ì œí’ˆ ìƒì‚° ì™„ë£Œê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„
lead_time = st.sidebar.slider("ìƒì‚° ë¦¬ë“œíƒ€ì„ (Days)", 1, 30, 7)

# ëª©í‘œ ì„œë¹„ìŠ¤ ë ˆë²¨: í’ˆì ˆì„ ì–¼ë§ˆë‚˜ í—ˆìš©í•˜ì§€ ì•Šì„ ê²ƒì¸ê°€? (95% = 100ë²ˆ ì¤‘ 5ë²ˆë§Œ í’ˆì ˆ í—ˆìš©)
service_level = st.sidebar.selectbox(
    "ëª©í‘œ ì„œë¹„ìŠ¤ ë ˆë²¨ (í’ˆì ˆ ë°©ì§€ìœ¨)", 
    [0.90, 0.95, 0.99], 
    index=1 # ê¸°ë³¸ê°’ì€ 95%
)

# ì¼í‰ê·  íŒë§¤ëŸ‰ ì„¤ì •
avg_demand = st.sidebar.number_input("ì˜ˆìƒ ì¼ì¼ í‰ê·  íŒë§¤ëŸ‰ (í†¤)", value=100)

# ---------------------------------------------------------
# 3. ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ (Data Generation)
# ---------------------------------------------------------
# 100ì¼ê°„ì˜ ê°€ìƒ ë°ì´í„°ë¥¼ ë§Œë“­ë‹ˆë‹¤. (ëœë¤í•˜ì§€ë§Œ í˜„ì‹¤ì ì¸ ì¶”ì„¸ ë°˜ì˜)
days = 100
x = np.linspace(0, 10, days) 

# [ì•Œê³ ë¦¬ì¦˜]
# 1. Trend: ì‹œì¥ ì„±ì¥ì„¸ (ìš°ìƒí–¥)
# 2. Seasonality: ê³„ì ˆì„± (Sine íŒŒë™)
# 3. Noise: ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë§¤ì¼ì˜ ë³€ë™ (Random)
trend = x * 2 + (avg_demand - 10) 
seasonality = np.sin(x) * 15
noise = np.random.normal(0, 10, days) # ì •ê·œë¶„í¬ë¥¼ ë”°ë¥´ëŠ” ì˜¤ì°¨

daily_sales = trend + seasonality + noise

# ë°ì´í„°í”„ë ˆì„(ì—‘ì…€í‘œ) ìƒì„±
df = pd.DataFrame({
    'ë‚ ì§œ': pd.date_range(start='2026-01-01', periods=days),
    'ì¼ì¼_íŒë§¤ëŸ‰': daily_sales
})

# ---------------------------------------------------------
# 4. SCM í•µì‹¬ ì§€í‘œ ê³„ì‚° (Calculation Logic)
# ---------------------------------------------------------
# í‘œì¤€í¸ì°¨(Standard Deviation): ìˆ˜ìš”ê°€ ì–¼ë§ˆë‚˜ ë“¤ì‘¥ë‚ ì‘¥í•œê°€? (ë¦¬ìŠ¤í¬ì˜ í¬ê¸°)
std_dev = df['ì¼ì¼_íŒë§¤ëŸ‰'].std()

# Z-Score ë³€í™˜ (í†µê³„í•™ì  ì‹ ë¢°êµ¬ê°„)
z_score_map = {0.90: 1.28, 0.95: 1.65, 0.99: 2.33}
z = z_score_map[service_level]

# [í•µì‹¬ ê³µì‹ 1] ì•ˆì „ ì¬ê³  = Z * í‘œì¤€í¸ì°¨ * sqrt(ë¦¬ë“œíƒ€ì„)
# ë¦¬ë“œíƒ€ì„ì´ ê¸¸ì–´ì§ˆìˆ˜ë¡ ë¶ˆí™•ì‹¤ì„±ì€ ì œê³±ê·¼(ë£¨íŠ¸)ì— ë¹„ë¡€í•´ ì»¤ì§„ë‹¤ëŠ” 'Risk Pooling' íš¨ê³¼ ë°˜ì˜
safety_stock = z * std_dev * np.sqrt(lead_time)

# [í•µì‹¬ ê³µì‹ 2] ì¬ë°œì£¼ì  (Reorder Point) = (ì¼í‰ê· ì†Œë¹„ * ë¦¬ë“œíƒ€ì„) + ì•ˆì „ì¬ê³ 
# ì°½ê³ ì— ì¬ê³ ê°€ ì´ë§Œí¼ ë‚¨ì•˜ì„ ë•Œ ë°œì£¼ë¥¼ ë„£ì–´ì•¼ ëŠ¦ì§€ ì•ŠìŒ
reorder_point = (df['ì¼ì¼_íŒë§¤ëŸ‰'].mean() * lead_time) + safety_stock

# ---------------------------------------------------------
# 5. ê²°ê³¼ ì‹œê°í™” (Visualization)
# ---------------------------------------------------------

# (1) ë©”ì¸ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
st.subheader("ğŸ“ˆ í–¥í›„ ìˆ˜ìš” ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜")
st.line_chart(df.set_index('ë‚ ì§œ'))

# (2) í•µì‹¬ ì§€í‘œ ì¹´ë“œ ë³´ì—¬ì£¼ê¸° (ë³´ê¸° ì¢‹ê²Œ 3ë‹¨ìœ¼ë¡œ ë°°ì¹˜)
col1, col2, col3 = st.columns(3)

with col1:
    st.metric(label="ğŸ“Š ìˆ˜ìš” ë³€ë™ì„± (í‘œì¤€í¸ì°¨)", value=f"{std_dev:.1f} í†¤")
    st.caption("ê°’ì´ í´ìˆ˜ë¡ ì˜ˆì¸¡ì´ ì–´ë µìŠµë‹ˆë‹¤.")

with col2:
    # ë¶‰ì€ìƒ‰ìœ¼ë¡œ ê°•ì¡°í•˜ì—¬ ë³´ì—¬ì¤Œ
    st.metric(label="ğŸ›¡ï¸ í•„ìš” ì•ˆì „ ì¬ê³ ", value=f"{int(safety_stock)} í†¤", delta=f"Lead Time {lead_time}ì¼ ê¸°ì¤€")
    st.caption("ëŒë°œ ìƒí™©ì— ëŒ€ë¹„í•œ ë³´í—˜ìš© ì¬ê³ ")

with col3:
    st.metric(label="ğŸ”„ ì¬ë°œì£¼ì  (ROP)", value=f"{int(reorder_point)} í†¤")
    st.caption("ì¬ê³ ê°€ ì´ ìˆ˜ì¤€ì´ ë˜ë©´ ìƒì‚° íˆ¬ì…!")

# (3) ë¶„ì„ ë¦¬í¬íŠ¸ ìë™ ìƒì„±
st.divider() # ê°€ë¡œì„  ê¸‹ê¸°
st.subheader("ğŸ“ AI ë¶„ì„ ì¸ì‚¬ì´íŠ¸")
st.info(f"""
- í˜„ì¬ ì„¤ì •í•˜ì‹  **ì„œë¹„ìŠ¤ ë ˆë²¨ {int(service_level*100)}%**ë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´ì„œëŠ”, 
- ì˜ˆìƒë˜ëŠ” ìˆ˜ìš” ë³€ë™ì— ëŒ€ë¹„í•´ ìµœì†Œ **{int(safety_stock)}í†¤**ì˜ ì•ˆì „ ì¬ê³ ë¥¼ ìƒì‹œ ë³´ìœ í•´ì•¼ í•©ë‹ˆë‹¤.
- ë§Œì•½ ë¦¬ë“œíƒ€ì„ì„ **{lead_time}ì¼**ì—ì„œ **{max(1, lead_time-2)}ì¼**ë¡œ 2ì¼ ë‹¨ì¶•í•œë‹¤ë©´, 
  ì•ˆì „ ì¬ê³ ë¥¼ ì•½ **{int(safety_stock - (z * std_dev * np.sqrt(max(1, lead_time-2))))}í†¤** ì¤„ì—¬ ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
""")